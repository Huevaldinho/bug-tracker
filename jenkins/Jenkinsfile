        pipeline {
            agent any

            stages {
                stage("Execute Unit Tests") {
                    parallel {
                        // ----------------------------------------------------
                        // STAGE 1: BACKEND
                        // ----------------------------------------------------
                        stage('Unit Tests - BackEnd') {
                            agent {
                                docker {
                                    image 'golang:tip-trixie'
                                    reuseNode true
                                    args '-e GOCACHE=/tmp/.cache -e GOMODCACHE=/tmp/.modcache'
                                }
                            }
                            steps {
                                dir('bugtracker-backend') {
                                    sh '''
                                        go install github.com/jstemmer/go-junit-report/v2@latest
                                        go test -v ./...  2>&1 | go-junit-report > test-results.xml
                                        go test -coverprofile=coverage.out -covermode=atomic ./...
                                        go tool cover -html=coverage.out -o coverage.html
                                        mkdir -p reports
                                        mv coverage.html reports/
                                    '''
                                }
                            }
                            post {
                                always {
                                    junit 'bugtracker-backend/test-results.xml'
                                    publishHTML(target: [
                                        reportDir: 'bugtracker-backend/reports',
                                        reportFiles: 'coverage.html',
                                        reportName: 'Backend Coverage Report',
                                        keepAll: true,
                                        alwaysLinkToLastBuild: true
                                    ])
                                }
                            }
                        } // Fin Backend

                        // ----------------------------------------------------
                        // STAGE 2: FRONTEND
                        // ----------------------------------------------------
                        stage('Unit Tests - FrontEnd') {
                            agent {
                                docker {
                                    image 'node:20-alpine'
                                    reuseNode true
                                }
                            }
                            steps {
                                dir('bugtracker-frontend') {
                                    sh '''
                                        npm ci
                                        npm test
                                        mkdir -p reports
                                        mv coverage reports/
                                    '''
                                }
                            }
                            post {
                                always {
                                    // Nota: Asegúrate que el archivo xml se genere en la raíz del dir frontend
                                    junit 'bugtracker-frontend/test-results.xml'
                                    publishHTML(target: [
                                        reportDir: 'bugtracker-frontend/reports/coverage',
                                        reportFiles: 'index.html',
                                        reportName: 'Frontend Coverage Report',
                                        keepAll: true,
                                        alwaysLinkToLastBuild: true
                                    ])
                                }
                            }
                        } // Fin Frontend
                    } // Fin Parallel
                } // Fin Stage "Execute Unit Tests"

                // ----------------------------------------------------
                // STAGE 3: Run APP
                // ----------------------------------------------------
                stage("Launch Application") {
                    agent {
                        docker {
                            image 'docker:27.5.1'
                            reuseNode true
                            args '-v /var/run/docker.sock:/var/run/docker.sock -u 0'
                        }
                    }
                    steps {
                        sh 'docker compose up --build -d'
                    }
                } // Fin Stage Launch

                // ----------------------------------------------------
                // STAGE 4: API Tests
                // ----------------------------------------------------
                stage("API Tests") {
                    agent {
                        docker {
                            image 'mcr.microsoft.com/playwright:v1.50.0-jammy'
                            reuseNode true
                            args '-u 0 --network=host'
                        }
                    }
                    steps {
                        dir('tests-api') {
                            sh '''
                                npx wait-port http://localhost:8080/api/health -t 30000
                                npm ci
                                npx playwright test
                            '''
                        }
                    }
                    post {
                        always{
                            junit 'tests-api/test-results/results.xml'
                            publishHTML(
                                target: [
                                    reportDir: 'tests-api/playwright-report',
                                    reportFiles: 'index.html',
                                    reportName: 'Playwright API Tests Report',
                                    keepAll: true,
                                    alwaysLinkToLastBuild: true
                                ]
                            )

                        }
                    }
                } // Fin Stage API

                // ----------------------------------------------------
                // STAGE 5: E2E Tests
                // ----------------------------------------------------
                stage ("E2E Tests"){
                    agent{
                        docker{
                            image 'mcr.microsoft.com/playwright:v1.50.0-jammy'
                            reuseNode true
                            args '-u 0 --network=host'
                        }
                    }
                    steps{
                        dir('tests-e2e'){
                            sh '''
                                npm ci
                                npx playwright test
                            '''
                        }
                    }
                    post {
                        always{
                            junit 'tests-e2e/test-results/results.xml'
                            publishHTML(
                                target: [
                                    reportDir: 'tests-e2e/playwright-report',
                                    reportFiles: 'index.html',
                                    reportName: 'Playwright E2E Tests Report',
                                    keepAll: true,
                                    alwaysLinkToLastBuild: true
                                ]
                            )

                        }
                    }
                }
                // ----------------------------------------------------
                // STAGE 6: Performance Tests
                // ----------------------------------------------------
                stage("Performance Tests"){
                    agent {
                        docker {
                            image 'grafana/k6:latest'
                            reuseNode true
                            args '-u root --network=host --entrypoint=""'
                        }
                    }
                    steps {
                        dir('tests-perf'){
                            sh '''
                                k6 run script.js
                            '''
                        }
                    }
                    post {
                        always{
                            publishHTML(
                                target: [
                                    reportDir: 'tests-perf',
                                    reportFiles: 'perf-results.html',
                                    reportName: 'K6 Performance Tests Report',
                                    keepAll: true,
                                    alwaysLinkToLastBuild: true
                                ]
                            )
                        }
                    }
                }

                // ----------------------------------------------------
                // STAGE 7: Deployment to Staging
                // ----------------------------------------------------
                stage ("Deploy to Staging"){
                    when {
                        expression {
                            return env.GIT_BRANCH == 'origin/main'
                        }
                    }
                    environment {
                        FLY_API_TOKEN = credentials('FLY_API_TOKEN')
                        FLYCTL_INSTALL = "${env.WORKSPACE.replaceAll(' ','')}/.fly"
                        PATH = "$FLYCTL_INSTALL/bin:$PATH"
                        HOME = "${WORKSPACE}"
                    }
                    stages {
                        stage("Install Flyctl"){
                        steps {
                            sh '''
                                mkdir -p $FLYCTL_INSTALL
                                curl -L https://fly.io/install.sh | sh
                                flyctl version
                            '''
                        }
                    }
                    stage ("Deploy Backend to Staging"){
                        steps {
                            dir('bugtracker-backend'){
                                sh '''
                                    flyctl deploy -c fly.staging.toml --remote-only
                                '''
                            }
                        }
                    }
                    stage ("Deploy Front to Staging"){
                        steps {
                            dir('bugtracker-frontend'){
                                sh '''
                                    flyctl deploy -c fly.staging.toml --remote-only
                                '''
                            }
                        }
                    }
                    }
                }

                // ----------------------------------------------------
                // STAGE 8: Post Deploy Tests
                // ----------------------------------------------------
                stage ("Post Deploy Tests"){
                    when {
                        expression {
                            return env.GIT_BRANCH == 'origin/main'
                        }
                    }
                    agent{
                        docker{
                            image 'mcr.microsoft.com/playwright:v1.50.0-jammy'
                            reuseNode true
                            args '-u 0'
                        }
                    }
                    environment{
                        PLAYWIGHT_TEST_BASE_URL = 'https://bugtracker-frontend-staging-white-brook-6357.fly.dev'
                    }
                    steps{
                        dir('tests-e2e'){
                            sh '''
                                npm ci
                                npx playwright test
                            '''
                        }
                    }
                    post {
                        always{
                            junit 'tests-e2e/test-results/results.xml'
                            publishHTML(
                                target: [
                                    reportDir: 'tests-e2e/playwright-report',
                                    reportFiles: 'index.html',
                                    reportName: 'Playwright Post Deploy Test Report',
                                    keepAll: true,
                                    alwaysLinkToLastBuild: true
                                ]
                            )

                        }
                    }
                }




            } // Fin Stages

            post {
                always {
                    cleanWs()
                    echo 'Pipeline execution completed.'
                }
            }
        } // Fin Pipeline